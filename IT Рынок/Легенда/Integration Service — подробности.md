Integration Service отвечает за взаимодействие с внешними логистическими операторами (DHL, Почта России и др.) и является критическим звеном между внутренним ядром системы и внешними системами доставки. Он изолирует бизнес-логику от специфики интеграций, что упрощает поддержку и масштабирование.

### Откуда берёт данные

- Подписывается на Kafka-топики `tracking.commands` (команды на обновление статусов) и `tracking.events` (новые внутренние события, требующие проверки у перевозчиков).
    
- Из PostgreSQL берёт настройки интеграций (`carriers`, `integrations_log`, retry-очередь).
    
- Может использовать Redis для временного хранения токенов/ключей доступа к внешним API.
    

### Что делает внутри (функционал)

- **Обращение к внешним API:** выполняет REST-запросы к системам DHL и Почты России через Spring WebClient. Поддерживает авторизацию (API-ключи, OAuth2, токены).
    
- **Нормализация данных:** каждая система возвращает разный формат событий, поэтому сервис приводит их к унифицированной DTO-модели (MapStruct + internal schema).
    
- **Обработка ошибок:** реализованы retries (Spring Retry/RetryTemplate), отложенные запросы и circuit breaker (Resilience4j). При неудаче событие отправляется в `dead.letters`.
    
- **Логирование:** каждый вызов фиксируется в `integrations_log` (время, payload, статус). Это помогает как для отладки, так и для SLA-отчётов.
    
- **Идемпотентность:** события маркируются `external_event_id`, чтобы избежать повторной обработки одного и того же статуса.
    
- **Расписание:** сервис может запускать периодические batch-запросы (например, ночное обновление треков за последние 24 часа).
    

### Куда отправляет

- В Kafka (`external.dhl.responses`, `external.post.responses`) публикует нормализованные ответы.
    
- В Kafka (`tracking.events`) отправляет новые статусы, пригодные для ядра Tracking Service.
    
- В PostgreSQL пишет логи вызовов и результаты в `integrations_log`.
    
- В Monitoring (Prometheus/Grafana) — метрики по SLA, ошибкам, задержкам.
    

**Итог:** Integration Service — связующее звено, которое берёт команды из системы, получает статусы у перевозчиков, нормализует их и передаёт в основной поток событий, гарантируя стабильность и единый формат данных.