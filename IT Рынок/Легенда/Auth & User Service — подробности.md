Auth & User Service — это центральный сервис аутентификации и управления пользователями, который обеспечивает безопасность всего трекинг-проекта. Он изолирован от других сервисов, но используется каждым при обращении через API Gateway.

### Откуда берёт данные

- Основной источник — таблица `users` в PostgreSQL. Она содержит поля: `id`, `username`, `password_hash`, `email`, `phone`, `role`, `permissions`, `status`, `created_at`.
    
- Дополнительно сервис обращается к таблице `clients` (для B2B-аккаунтов и их администраторов).
    
- Для проверки токенов сессий и ограничения частоты запросов используется Redis (хранение refresh-токенов и blacklist).
    
- Для аудита сервис пишет записи в `audit_logs`.
    

### Что делает внутри (функционал)

- **Регистрация/создание пользователей:** добавление новых B2B-клиентов или внутренних операторов. Пароли хэшируются через BCrypt.
    
- **Аутентификация:** проверка логина/пароля, генерация JWT (или OAuth2 access/refresh токенов).
    
- **Авторизация:** проверка ролей и прав доступа (например, клиент может видеть только свои посылки, оператор — все).
    
- **Управление ролями и правами:** выдача/отзыв прав, назначение админов, разграничение доступа по CRUD-операциям.
    
- **Сессии и токены:** хранение refresh-токенов в Redis, поддержка logout (через blacklist), автообновление access-токенов.
    
- **Безопасность:** защита от brute force (rate limiting), блокировка учётки после N неудачных входов, 2FA (через SMS/email сервисы).
    
- **Интеграция с внешними системами:** поддержка SSO (например, через OAuth2/OpenID Connect для корпоративных клиентов).
    
- **Аудит:** запись действий в PostgreSQL (`audit_logs`), логирование в Kafka для BI и мониторинга.
    

### Куда отправляет

- Возвращает в API Gateway access/refresh токены.
    
- Передаёт в другие микросервисы сведения об аутентифицированном пользователе через JWT claims (id, role, clientId).
    
- В Kafka публикует события типа `user.created`, `user.blocked`, `user.roleChanged`.
    
- В `audit_logs` пишет действия пользователей (login, logout, изменение профиля).
    

**Итог:** сервис является ядром безопасности: проверяет идентичность, управляет ролями, ограничивает доступ и формирует событийный след для мониторинга.