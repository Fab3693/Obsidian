CRM Sync Service — это специализированный микросервис, отвечающий за синхронизацию данных о статусах посылок с внутренней CRM-системой компании. Его задача — автоматизировать обновление клиентских карточек и устранить необходимость ручного ввода информации о доставках.

Откуда берёт данные

- **Kafka (`tracking.events`)** — основное место получения информации. Все изменения статусов посылок, зафиксированные в Tracking Service, транслируются сюда.
    
- **PostgreSQL (`integrations_log`)** — хранит историю синхронизаций и статусы их выполнения (успешно, ошибка, повторная попытка).
    
- **CRM API (внешнее)** — используется для валидации текущего состояния и проверки, требуется ли обновление.
    

Что делает внутри (функционал)

- **Подписка на события:** слушает Kafka-топики с новыми статусами.
    
- **Трансформация данных:** конвертирует событие в формат, который ожидает CRM (обычно REST DTO с полями `clientId`, `shipmentId`, `status`, `timestamp`).
    
- **Идемпотентность:** проверяет, не было ли уже отправлено событие с тем же идентификатором (`event_id`) в CRM, чтобы избежать дублирования.
    
- **Обработка ошибок:** при недоступности CRM сервис откладывает отправку и сохраняет задачу в retry-очередь; при превышении лимита попыток пишет событие в `dead.letters`.
    
- **Логирование:** фиксирует в `integrations_log` дату отправки, payload, результат (успех/ошибка).
    
- **Безопасность:** все запросы в CRM подписываются сервисным токеном/ключом.
    
- **Мониторинг SLA:** считает процент успешных синхронизаций и задержки между событием и записью в CRM.
    

Куда отправляет

- **CRM API:** отправляет обновления статусов и событий доставки (REST-запросы).
    
- **PostgreSQL:** сохраняет логи вызовов, результаты синхронизации и данные о retry.
    
- **Kafka (`crm.sync`)** — публикует события о результатах синхронизации (успех/ошибка) для последующего анализа и мониторинга.
    
- **Monitoring (Prometheus/Grafana):** метрики синхронизации и алерты о сбоях.
    

**Итог:** CRM Sync Service гарантирует, что CRM всегда отображает актуальные статусы посылок, облегчает работу менеджеров и повышает качество обслуживания клиентов.