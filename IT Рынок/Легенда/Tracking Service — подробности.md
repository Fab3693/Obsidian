Tracking Service — это центральный микросервис системы, который отвечает за хранение и обработку всех данных, связанных с посылками и их статусами. Он является «источником истины» (system of record) для сущностей доставки и выступает основой для остальных сервисов.

Откуда берёт данные

- **PostgreSQL** — таблицы `shipments`, `shipment_events`, `recipients`, `addresses`. Именно здесь хранится текущее состояние и история каждой посылки.
    
- **Kafka** — топики `external.dhl.responses`, `external.post.responses`, откуда приходят новые статусы от Integration Service.
    
- **API Gateway** — получает REST-запросы от клиентов (через фронтенд или мобильное приложение).
    
- **Redis** — кэш последних статусов для ускорения выдачи популярных запросов.
    

Что делает внутри (функционал)

- **CRUD-операции над отправлениями:** создание записей о новых посылках, обновление информации, закрытие/удаление.
    
- **Обновление статусов:** получение новых событий (через Kafka), их валидация, сохранение в `shipment_events` и обновление «текущего статуса» в `shipments`.
    
- **Агрегация информации:** при запросе клиента сервис собирает данные о посылке, последнем статусе, прогнозируемой дате доставки и контактных данных получателя.
    
- **Поиск:** поддержка фильтров по дате, статусу, клиенту и поиск по телефону (через Criteria API).
    
- **Валидация и нормализация:** проверка формата данных, идемпотентность событий (по `event_id`), обработка конфликтов версий.
    
- **Бизнес-правила:** логика расчёта SLA, определение просрочек, формирование бизнес-ивентов (например, «посылка задержана»).
    
- **API-слой:** предоставляет REST-эндпоинты для BFF (например, `/shipments/{id}`, `/shipments/search`).
    

Куда отправляет

- **Kafka (`tracking.events`)** — публикация новых или обновлённых статусов, которые используются CRM, Notification Service и аналитикой.
    
- **PostgreSQL** — запись состояния и истории посылок.
    
- **API Gateway** — отдаёт REST-ответы клиентам (агрегированные данные по отправлению).
    
- **Redis** — обновляет кэш последних статусов.
    
- **Monitoring** — метрики по скорости обработки событий, количеству запросов, SLA-достижениям.
    

**Итог:** Tracking Service — ядро системы, в котором сходятся все потоки данных: клиенты читают из него статусы, интеграции пишут в него события, а остальные сервисы полагаются на его консистентность.